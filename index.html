<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>üéÑ Tree Counter (Full)</title>

<!-- PocketBase JS -->
<script src="https://unpkg.com/pocketbase@latest/dist/pocketbase.umd.js"></script>

<style>
  /* --- Layout / Theme (mobile-first) --- */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html,body { width:100%; min-height:100vh; overflow-x:hidden; -webkit-tap-highlight-color: transparent; }
  body {
    display:flex; justify-content:center; align-items:flex-start;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(#ef4444, #7f1d1d); color:white; padding:18px 0;
  }
  .container { width:100%; max-width:420px; padding:0 14px; text-align:center; }

  h1 { font-size:1.5rem; margin-bottom:10px; text-shadow:0 2px 3px rgba(0,0,0,0.35); }

  .card {
    background: rgba(255,255,255,0.12);
    border: 1px solid rgba(255,255,255,0.18);
    padding:14px;
    border-radius:14px;
    margin:10px 0;
    box-shadow: 0 6px 18px rgba(0,0,0,0.25);
  }

  #totalCount { font-size:2.8rem; font-weight:800; color:#fcd34d; margin-top:6px; }
  #userCount { font-size:1.6rem; font-weight:700; color:#bbf7d0; margin-top:6px; }

  /* Tree image button (option D) */
  .tree-button {
    width:120px;
    height:120px;
    object-fit:contain;
    cursor:pointer;
    border-radius:14px;
    border: 2px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.02);
    display:inline-block;
    transition: transform .13s ease, box-shadow .13s ease;
    margin:12px auto 6px;
  }
  .tree-button:hover { transform: scale(1.06); box-shadow: 0 8px 18px rgba(0,0,0,0.35); }
  .tree-button:active { transform: scale(0.94); }

  /* Remove button (smaller, red) */
  .remove-btn {
    width:100%;
    padding:10px;
    margin-top:8px;
    font-size:1rem;
    background:#ef4444;
    color:white;
    border:none;
    border-radius:10px;
    cursor:pointer;
    font-weight:700;
    transition: transform .1s ease, background .12s ease;
  }
  .remove-btn:hover { background:#dc2626; }
  .remove-btn:active { transform: scale(.97); background:#b91c1c; }

  .remove-icon { color:white; text-shadow:0 0 3px rgba(0,0,0,0.6); font-weight:900; margin-right:8px; }

  /* Log list */
  #logList { text-align:left; max-height:220px; overflow:auto; font-size:0.9rem; margin-top:8px; }
  #logList div { padding:6px 4px; border-bottom:1px dashed rgba(255,255,255,0.06); }

  .small-btn {
    display:inline-block; padding:8px 12px; margin-top:10px; border-radius:10px; background:rgba(255,255,255,0.06);
    color:white; border:1px solid rgba(255,255,255,0.08); cursor:pointer; font-weight:600;
  }
  .small-btn:active { transform: translateY(1px); }

  .status { margin-top:8px; font-size:0.9rem; opacity:0.95; }
  .muted { opacity:0.8; font-size:0.9rem; }

  /* very small screens */
  @media (max-width:360px) {
    .tree-button { width:100px; height:100px; }
    #totalCount { font-size:2.2rem; }
  }
</style>
</head>
<body>
  <div class="container">
    <h1>üéÑ Tree Counter</h1>

    <div class="card" id="globalCard">
      <div>Total Trees</div>
      <div id="totalCount">‚Äî</div>
      <div class="muted" style="font-size:.9rem; margin-top:6px;">Global count and activity log</div>
    </div>

    <div class="card" id="userCard">
      <div>Your Trees</div>
      <div id="userCount">‚Äî</div>

      <!-- === Replace PB_URL and GLOBAL_RECORD_ID below BEFORE using === -->
      <!-- Option D: image button used as Add Tree control (clicking the image calls handleAdd()) -->
      <img
        id="addTreeImage"
        class="tree-button"
        src="https://oaidalleapiprodscus.blob.core.windows.net/private/org-9Poo2wYt1dZQWqZXecxYfrsO/user-YzZPjJ0r32SMhCliVUHjxEuC/img-HkDWl95Tftq7VhccAy4qEoA9.png"
        alt="Add Tree"
        onclick="handleAdd()"
        />

      <!-- Fallback textual button if image fails to load -->
      <button id="addFallback" style="display:none; margin-top:8px;" onclick="handleAdd()">üéÅ Add Tree</button>

      <button class="remove-btn" onclick="handleRemove()"><span class="remove-icon">‚úñÔ∏è</span>Remove Tree</button>
    </div>

    <div class="card">
      <button class="small-btn" onclick="viewLogs()">üìú View My Log</button>
      <button class="small-btn" onclick="downloadAllLogsCSV()">‚¨áÔ∏è Download CSV</button>
      <div id="status" class="status"></div>
      <div id="logList"></div>
    </div>

    <div style="height:10px"></div>
  </div>

<script>
/*
  IMPORTANT: Edit these two values to match your Render deployment BEFORE opening this page:
*/
const PB_URL = "https://tree-counter-backend.onrender.com"; // <-- your Render PocketBase root URL
const GLOBAL_RECORD_ID = "ubr2lvzy7905x8q"; // <-- the id of the single tree_count record

/* Collection names (match exactly to your PocketBase collections) */
const GLOBAL_COLLECTION = "tree_count";
const USER_COLLECTION   = "app_users";

/* PocketBase client */
const pb = new PocketBase(PB_URL);

/* Local state */
let userId = null;
let userName = null;

/* Utility: set status text */
function setStatus(msg, isError=false) {
  const el = document.getElementById("status");
  el.textContent = msg || "";
  el.style.color = isError ? "#ffdddd" : "white";
}

/* --- Initialize user: prompt for name or reuse localStorage --- */
async function initUser() {
  userName = localStorage.getItem("treeUserName");
  if (!userName) {
    userName = prompt("Enter your name (first name is fine):");
    if (!userName) {
      alert("Name required to use the app.");
      return;
    }
    localStorage.setItem("treeUserName", userName);
  }

  // Try to find existing user record
  try {
    const existing = await pb.collection(USER_COLLECTION).getFirstListItem(`name="${userName}"`);
    userId = existing.id;
    setStatus(`Welcome back, ${userName}`);
  } catch (err) {
    // Not found -> create
    try {
      const newUser = await pb.collection(USER_COLLECTION).create({
        name: userName,
        trees: 0,
        logs: []
      });
      userId = newUser.id;
      setStatus(`Hi ${userName} ‚Äî new user created`);
    } catch (e) {
      console.error("Failed creating user", e);
      setStatus("Error creating user. See console.", true);
    }
  }
}

/* --- Load counts for display --- */
async function loadData() {
  if (!GLOBAL_RECORD_ID || GLOBAL_RECORD_ID.includes("REPLACE")) {
    setStatus("Please set GLOBAL_RECORD_ID in the script before use.", true);
    return;
  }
  try {
    const globalRec = await pb.collection(GLOBAL_COLLECTION).getOne(GLOBAL_RECORD_ID);
    document.getElementById("totalCount").textContent = typeof globalRec.count === "number" ? globalRec.count : 0;
    if (userId) {
      const u = await pb.collection(USER_COLLECTION).getOne(userId);
      document.getElementById("userCount").textContent = typeof u.trees === "number" ? u.trees : 0;
    } else {
      document.getElementById("userCount").textContent = "‚Äî";
    }
    setStatus(""); // clear status
  } catch (err) {
    console.error("loadData failed", err);
    setStatus("Failed to load data. Check console.", true);
  }
}

/* --- Update both global and user records atomically-ish (two calls) --- */
async function updateCounts(change) {
  if (!userId) { setStatus("No user ID ‚Äî refresh and enter name.", true); return; }

  try {
    // fetch latest global record
    const globalRec = await pb.collection(GLOBAL_COLLECTION).getOne(GLOBAL_RECORD_ID);
    const globalCount = Math.max(0, (globalRec.count || 0) + change);

    // prepare log entry
    const entry = {
      userId: userId,
      userName: userName,
      change: change,
      ts: new Date().toISOString()
    };

    // update global logs array (ensure array)
    const glogs = Array.isArray(globalRec.log) ? globalRec.log.slice() : [];
    glogs.push(entry);

    // patch global
    await pb.collection(GLOBAL_COLLECTION).update(GLOBAL_RECORD_ID, {
      count: globalCount,
      log: glogs
    });

    // update user record
    const userRec = await pb.collection(USER_COLLECTION).getOne(userId);
    const newUserCount = Math.max(0, (userRec.trees || 0) + change);
    const ulogs = Array.isArray(userRec.logs) ? userRec.logs.slice() : [];
    ulogs.push(entry);

    await pb.collection(USER_COLLECTION).update(userId, {
      trees: newUserCount,
      logs: ulogs
    });

    // reload display
    await loadData();
  } catch (err) {
    console.error("updateCounts failed", err);
    setStatus("Error updating counter. See console.", true);
    alert("Error updating counter. See console.");
  }
}

/* --- UI handlers --- */
async function handleAdd() { await updateCounts(1); triggerSnow(); }
async function handleRemove() { await updateCounts(-1); triggerSnow(); }

/* --- Snow + sound (small flourish) --- */
function triggerSnow() {
  // play sleigh for 3s
  const audio = document.getElementById("sleighAudio");
  if (audio) {
    audio.currentTime = 0;
    audio.play().catch(()=>{/* autoplay may be blocked on some browsers; that's fine */});
    setTimeout(()=>audio.pause(), 3000);
  }

  // create some snow flakes
  for (let i=0;i<10;i++) {
    const f = document.createElement("div");
    f.className = "snowflake";
    f.textContent = "‚ùÑ";
    f.style.left = `${Math.random() * 90 + 5}vw`;
    f.style.fontSize = `${8 + Math.random()*12}px`;
    f.style.opacity = (0.5 + Math.random()*0.5);
    f.style.animation = `fall ${4 + Math.random()*3}s linear`;
    document.body.appendChild(f);
    setTimeout(()=>f.remove(), 7000);
  }
}

/* --- View only current user's logs (from app_users.logs) --- */
async function viewLogs() {
  if (!userId) { alert("No user ‚Äî refresh and enter your name."); return; }
  try {
    const u = await pb.collection(USER_COLLECTION).getOne(userId);
    const logs = Array.isArray(u.logs) ? u.logs.slice().sort((a,b)=>new Date(a.ts)-new Date(b.ts)) : [];
    const div = document.getElementById("logList");
    div.innerHTML = "";
    if (logs.length === 0) {
      div.textContent = "No log entries yet.";
      return;
    }
    logs.forEach(e => {
      const d = new Date(e.ts).toLocaleString();
      const t = e.change > 0 ? `Added üéÑ` : `Removed ‚úñÔ∏è`;
      const el = document.createElement("div");
      el.textContent = `${