<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>üéÑ Tree Counter üéÑ</title>

<script src="https://unpkg.com/pocketbase@latest/dist/pocketbase.umd.js"></script>

<style>
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
    background: linear-gradient(#b91c1c, #7f1d1d);
    color: white;
    display: flex;
    justify-content: center;
    padding: 10px;
    min-height: 100vh;
    overflow-x: hidden;
  }
  .container {
    width: 100%;
    max-width: 400px;
    text-align: center;
  }
  h1 {
    font-size: 1.8rem;
    margin-bottom: 10px;
    text-shadow: 0 2px 3px rgba(0,0,0,0.3);
  }
  .card {
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.3);
    padding: 20px;
    border-radius: 20px;
    backdrop-filter: blur(12px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.25);
    margin-bottom: 15px;
    position: relative;
    width: 100%;
  }
  #totalCount {
    font-size: 3rem;
    font-weight: 800;
    color: #fcd34d;
  }
  #userCount {
    font-size: 2rem;
    font-weight: 700;
    color: #a3e635;
  }
  button {
    width: 100%;
    padding: 18px;
    background: #16a34a;
    color: white;
    font-size: 1.5rem;
    border: none;
    border-radius: 16px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 12px;
    transition: transform 0.1s ease, background 0.2s ease;
  }
  button:hover {
    background: #15803d;
  }
  button:active {
    transform: scale(0.96);
    background: #166534;
  }
  .snowflake {
    position: fixed;
    top: -10px;
    color: white;
    font-size: 10px;
    opacity: 0.8;
    pointer-events: none;
    user-select: none;
    z-index: 9999;
    animation: fall linear forwards;
  }
  @keyframes fall {
    to { transform: translateY(110vh); }
  }
  #logList {
    margin-top: 10px;
    text-align: left;
    max-height: 180px;
    overflow-y: auto;
    font-size: 0.85rem;
  }
</style>
</head>
<body>
<div class="container">
  <h1>üéÑ Tree Counter üéÑ</h1>

  <audio id="sleighAudio" src="https://www.orangefreesounds.com/wp-content/uploads/2016/12/Sleigh-bells-sound.mp3" preload="auto"></audio>

  <div class="card">
    <div>Total Trees</div>
    <div id="totalCount">0</div>
  </div>

  <div class="card">
    <div>Your Trees</div>
    <div id="userCount">0</div>
    <button onclick="handleAdd()">üéÅ Add Tree</button>
    <button onclick="handleRemove()">‚ùå Remove Tree</button>
  </div>

  <div class="card">
    <button onclick="viewLogs()">üìú View My Log</button>
    <div id="logList"></div>
  </div>
</div>

<script>
  const pb = new PocketBase("https://tree-counter-backend-o0al.onrender.com");
  const globalCollection = "tree_count";
  const globalRecordId = "qj2f53koqvpy72i"; // replace with your record ID
  const userCollection = "users";

  let userId = null;
  let userName = null;

  async function initUser() {
    userName = localStorage.getItem("treeUserName");
    if (!userName) {
      userName = prompt("Enter your name:");
      if (!userName) { alert("Name is required!"); return; }
      localStorage.setItem("treeUserName", userName);
    }
    try {
      const existing = await pb.collection(userCollection).getFirstListItem(`name="${userName}"`);
      userId = existing.id;
    } catch {
      const newUser = await pb.collection(userCollection).create({
        name: userName,
        count: 0,
        logs: []
      });
      userId = newUser.id;
    }
  }

  async function loadData() {
    const global = await pb.collection(globalCollection).getOne(globalRecordId);
    document.getElementById("totalCount").textContent = global.count;
    if (userId) {
      const user = await pb.collection(userCollection).getOne(userId);
      document.getElementById("userCount").textContent = user.count;
    }
  }

  async function handleAdd() { await updateCounts(1); triggerSnow(); }
  async function handleRemove() { await updateCounts(-1); triggerSnow(); }

  async function updateCounts(change) {
    try {
      const global = await pb.collection(globalCollection).getOne(globalRecordId);
      let newGlobal = global.count + change;
      if (newGlobal < 0) newGlobal = 0;
      let globalLogs = global.logs || [];
      globalLogs.push({ type: change > 0 ? "add" : "remove", timestamp: new Date().toISOString() });
      await pb.collection(globalCollection).update(globalRecordId, { count: newGlobal, logs: globalLogs });

      const user = await pb.collection(userCollection).getOne(userId);
      let newUserCount = user.count + change;
      if (newUserCount < 0) newUserCount = 0;
      let userLogs = user.logs || [];
      userLogs.push({ type: change > 0 ? "add" : "remove", timestamp: new Date().toISOString() });
      await pb.collection(userCollection).update(userId, { count: newUserCount, logs: userLogs });

      await loadData();
    } catch (err) {
      console.error("Update failed:", err);
      alert("Error updating counter. See console.");
    }
  }

  function triggerSnow() {
    const audio = document.getElementById("sleighAudio");
    audio.currentTime = 0;
    audio.play();
    setTimeout(() => audio.pause(), 3000);

    for (let i = 0; i < 10; i++) {
      const flake = document.createElement("div");
      flake.className = "snowflake";
      flake.textContent = "‚ùÑ";
      flake.style.left = Math.random() * 100 + "vw";
      flake.style.fontSize = (8 + Math.random() * 10) + "px"; // slightly larger for visibility
      flake.style.opacity = 0.6 + Math.random() * 0.4;
      flake.style.animationDuration = (5 + Math.random() * 3) + "s"; // slower
      document.body.appendChild(flake);
      setTimeout(() => flake.remove(), 6000);
    }
  }

  async function viewLogs() {
    if (!userId) return;
    try {
      const user = await pb.collection(userCollection).getOne(userId);
      const logs = (user.logs || []).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
      const logDiv = document.getElementById("logList");
      logDiv.innerHTML = "";
      if (logs.length === 0) {
        logDiv.textContent = "No log entries yet.";
        return;
      }
      logs.forEach(entry => {
        const dateStr = new Date(entry.timestamp).toLocaleString();
        const typeStr = entry.type === "add" ? "Added üéÑ" : "Removed ‚ùå";
        const div = document.createElement("div");
        div.textContent = `${dateStr}: ${typeStr}`;
        logDiv.appendChild(div);
      });
    } catch (err) {
      console.error("Failed to fetch logs:", err);
      alert("Could not load logs. See console.");
    }
  }

  (async function start() {
    await initUser();
    await loadData();
  })();
</script>
</body>
</html>