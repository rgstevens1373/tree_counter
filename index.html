<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>üéÑ Christmas Tree Counter</title>

<script src="https://unpkg.com/pocketbase@latest/dist/pocketbase.umd.js"></script>

<style>
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
    background: linear-gradient(#b91c1c, #7f1d1d);
    color: white;
    display: flex;
    justify-content: center;
    padding: 20px;
    min-height: 100vh;
    overflow-x: hidden;
  }
  .container {
    width: 100%;
    max-width: 420px;
    text-align: center;
  }
  h1 {
    font-size: 2.4rem;
    margin-bottom: 10px;
    text-shadow: 0 3px 4px rgba(0,0,0,0.3);
  }
  .card {
    background: rgba(255,255,255,0.15);
    border: 2px solid rgba(255,255,255,0.3);
    padding: 30px;
    border-radius: 20px;
    backdrop-filter: blur(12px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.25);
    margin-bottom: 20px;
    position: relative;
  }
  #totalCount {
    font-size: 4rem;
    font-weight: 800;
    color: #fcd34d;
  }
  #userCount {
    font-size: 2.5rem;
    font-weight: 700;
    color: #a3e635;
  }
  button {
    width: 100%;
    padding: 18px;
    background: #16a34a;
    color: white;
    font-size: 1.5rem;
    border: none;
    border-radius: 14px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 20px;
    transition: transform 0.1s ease, background 0.2s ease;
  }
  button:hover {
    background: #15803d;
  }
  button:active {
    transform: scale(0.95);
    background: #166534;
  }
  .snowflake {
    position: fixed;
    top: -10px;
    color: white;
    font-size: 1.2rem;
    opacity: 0.9;
    pointer-events: none;
    user-select: none;
    z-index: 9999;
    animation: fall linear forwards;
  }
  @keyframes fall {
    to { transform: translateY(110vh); }
  }
  #logList {
    margin-top: 10px;
    text-align: left;
    max-height: 200px;
    overflow-y: auto;
    font-size: 0.9rem;
  }
</style>
</head>
<body>
    <audio id="sleighAudio" src="https://www.soundjay.com/holiday/sounds/sleigh-bells-1.mp3" preload="auto"></audio>
<div class="container">
  <h1>üéÑ Christmas Tree Counter üéÑ</h1>

  <div class="card">
    <div>Total Trees</div>
    <div id="totalCount">0</div>
  </div>

  <div class="card">
    <div>Your Trees</div>
    <div id="userCount">0</div>
    <button onclick="handleAdd()">üéÅ Add Tree</button>
    <button onclick="handleRemove()">‚ùå Remove Tree</button>
  </div>

  <div class="card">
    <button onclick="viewLogs()">üìú View My Log</button>
    <div id="logList"></div>
  </div>
</div>

<script>
  const pb = new PocketBase("https://tree-counter-backend-o0al.onrender.com");
  const globalCollection = "tree_count";
  const globalRecordId = "qj2f53koqvpy72i";  // Replace with your record ID
  const userCollection = "users";

  let userId = null;
  let userName = null;

  // Prompt for user name and create/fetch record
  async function initUser() {
    userName = localStorage.getItem("treeUserName");
    if (!userName) {
      userName = prompt("Enter your name:");
      if (!userName) {
        alert("Name is required!");
        return;
      }
      localStorage.setItem("treeUserName", userName);
    }
    try {
      const existing = await pb.collection(userCollection).getFirstListItem(`name="${userName}"`);
      userId = existing.id;
    } catch {
      const newUser = await pb.collection(userCollection).create({
        name: userName,
        count: 0,
        logs: []
      });
      userId = newUser.id;
    }
  }

  async function loadData() {
    const global = await pb.collection(globalCollection).getOne(globalRecordId);
    document.getElementById("totalCount").textContent = global.count;

    if (userId) {
      const user = await pb.collection(userCollection).getOne(userId);
      document.getElementById("userCount").textContent = user.count;
    }
  }

  async function handleAdd() { await updateCounts(1); triggerSnow(); }
  async function handleRemove() { await updateCounts(-1); triggerSnow(); }

  async function updateCounts(change) {
    try {
      // Global
      const global = await pb.collection(globalCollection).getOne(globalRecordId);
      let newGlobal = global.count + change;
      if (newGlobal < 0) newGlobal = 0;
      let globalLogs = global.logs || [];
      globalLogs.push({ type: change > 0 ? "add" : "remove", timestamp: new Date().toISOString() });
      await pb.collection(globalCollection).update(globalRecordId, {
        count: newGlobal,
        logs: globalLogs
      });

      // User
      const user = await pb.collection(userCollection).getOne(userId);
      let newUserCount = user.count + change;
      if (newUserCount < 0) newUserCount = 0;
      let userLogs = user.logs || [];
      userLogs.push({ type: change > 0 ? "add" : "remove", timestamp: new Date().toISOString() });
      await pb.collection(userCollection).update(userId, {
        count: newUserCount,
        logs: userLogs
      });

      await loadData();
    } catch (err) {
      console.error("Update failed:", err);
      alert("Error updating counter. See console.");
    }
  }

  function triggerSnow() {
  // Play sleighbell
  const audio = document.getElementById("sleighAudio");
  audio.currentTime = 0; // restart if already playing
  audio.play();

  // Snowflakes
  for (let i = 0; i < 15; i++) {
    const flake = document.createElement("div");
    flake.className = "snowflake";
    flake.textContent = "‚ùÑ";
    flake.style.left = Math.random() * 100 + "vw";
    flake.style.fontSize = (10 + Math.random() * 20) + "px";
    flake.style.opacity = Math.random();
    flake.style.animationDuration = (2 + Math.random() * 3) + "s";
    document.body.appendChild(flake);
    setTimeout(() => flake.remove(), 4000);
  }
}
  }

  async function viewLogs() {
    if (!userId) return;
    try {
      const user = await pb.collection(userCollection).getOne(userId);
      const logs = (user.logs || []).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
      const logDiv = document.getElementById("logList");
      logDiv.innerHTML = "";
      if (logs.length === 0) {
        logDiv.textContent = "No log entries yet.";
        return;
      }
      logs.forEach(entry => {
        const dateStr = new Date(entry.timestamp).toLocaleString();
        const typeStr = entry.type === "add" ? "Added üéÑ" : "Removed ‚ùå";
        const div = document.createElement("div");
        div.textContent = `${dateStr}: ${typeStr}`;
        logDiv.appendChild(div);
      });
    } catch (err) {
      console.error("Failed to fetch logs:", err);
      alert("Could not load logs. See console.");
    }
  }

  (async function start() {
    await initUser();
    await loadData();
  })();
</script>
</body>
</html>